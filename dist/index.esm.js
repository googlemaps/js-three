import{Vector3 as t,MathUtils as e,Quaternion as r,Matrix4 as n,Raycaster as s,Scene as a,PerspectiveCamera as i,Euler as o,WebGLRenderer as h,PCFSoftShadowMap as d,REVISION as l,sRGBEncoding as c,HemisphereLight as y,DirectionalLight as u}from"three";const{atan:p,cos:g,exp:v,log:m,tan:w,PI:x}=Math,{degToRad:A,radToDeg:M}=e,b=6371010,L=Math.PI*b;function f(t){return window.google&&google.maps&&(t instanceof google.maps.LatLng||t instanceof google.maps.LatLngAltitude)?{altitude:0,...t.toJSON()}:{altitude:0,...t}}function S(e,r,n=new t){const[s,a]=C(e),[i,o]=C(r);return n.set(s-i,a-o,0),n.multiplyScalar(g(A(r.lat))),n.z=e.altitude-r.altitude,n}function C(t){return[b*A(t.lng),b*m(w(.25*x+.5*A(t.lat)))]}function D(t){const[e,r]=t;return{lat:M(.5*x-2*p(v(-r/b))),lng:M(e)/b}}const R=new t(0,0,1);class I{constructor(t={}){this.animationMode="ondemand",this.rotationArray=new Float32Array(3),this.rotationInverse=new r,this.projectionMatrixInverse=new n,this.raycaster=new s;const{anchor:e={lat:0,lng:0,altitude:0},upAxis:o="Z",scene:h,map:d,animationMode:l="ondemand",addDefaultLighting:c=!0}=t;this.overlay=new google.maps.WebGLOverlayView,this.renderer=null,this.camera=null,this.animationMode=l,this.setAnchor(e),this.setUpAxis(o),this.scene=h??new a,c&&this.initSceneLights(),this.overlay.onAdd=this.onAdd.bind(this),this.overlay.onRemove=this.onRemove.bind(this),this.overlay.onContextLost=this.onContextLost.bind(this),this.overlay.onContextRestored=this.onContextRestored.bind(this),this.overlay.onStateUpdate=this.onStateUpdate.bind(this),this.overlay.onDraw=this.onDraw.bind(this),this.camera=new i,d&&this.setMap(d)}setAnchor(t){this.anchor=f(t)}setUpAxis(n){const s=new t(0,0,1);"string"!=typeof n?s.copy(n):"y"===n.toLowerCase()?s.set(0,1,0):"z"!==n.toLowerCase()&&console.warn(`invalid value '${n}' specified as upAxis`),s.normalize();const a=new r;a.setFromUnitVectors(s,R),this.rotationInverse.copy(a).invert();const i=(new o).setFromQuaternion(a,"XYZ");this.rotationArray[0]=e.radToDeg(i.x),this.rotationArray[1]=e.radToDeg(i.y),this.rotationArray[2]=e.radToDeg(i.z)}raycast(t,e,r={}){let n;Array.isArray(e)?n=e||null:(n=[this.scene],r={...e,recursive:!0});const{updateMatrix:s=!0,recursive:a=!1,raycasterParameters:i}=r;s&&this.projectionMatrixInverse.copy(this.camera.projectionMatrix).invert(),this.raycaster.ray.origin.set(t.x,t.y,0).applyMatrix4(this.projectionMatrixInverse),this.raycaster.ray.direction.set(t.x,t.y,.5).applyMatrix4(this.projectionMatrixInverse).sub(this.raycaster.ray.origin).normalize();const o=this.raycaster.params;i&&(this.raycaster.params=i);const h=this.raycaster.intersectObjects(n,a);return this.raycaster.params=o,h}onStateUpdate(){}onAdd(){}onBeforeDraw(){}onRemove(){}requestStateUpdate(){this.overlay.requestStateUpdate()}requestRedraw(){this.overlay.requestRedraw()}getMap(){return this.overlay.getMap()}setMap(t){this.overlay.setMap(t)}addListener(t,e){return this.overlay.addListener(t,e)}onContextRestored({gl:t}){this.renderer=new h({canvas:t.canvas,context:t,...t.getContextAttributes()}),this.renderer.autoClear=!1,this.renderer.autoClearDepth=!1,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=d,Number(l)<152&&(this.renderer.outputEncoding=c);const{width:e,height:r}=t.canvas;this.renderer.setViewport(0,0,e,r)}onContextLost(){this.renderer&&(this.renderer.dispose(),this.renderer=null)}onDraw({gl:t,transformer:e}){this.camera.projectionMatrix.fromArray(e.fromLatLngAltitude(this.anchor,this.rotationArray)),t.disable(t.SCISSOR_TEST),this.onBeforeDraw(),this.renderer.render(this.scene,this.camera),this.renderer.resetState(),"always"===this.animationMode&&this.requestRedraw()}latLngAltitudeToVector3(e,r=new t){return S(f(e),this.anchor,r),r.applyQuaternion(this.rotationInverse),r}bindTo(t,e,r,n){this.overlay.bindTo(t,e,r,n)}get(t){return this.overlay.get(t)}notify(t){this.overlay.notify(t)}set(t,e){this.overlay.set(t,e)}setValues(t){this.overlay.setValues(t)}unbind(t){this.overlay.unbind(t)}unbindAll(){this.overlay.unbindAll()}initSceneLights(){const t=new y(16777215,4473924,1);t.position.set(0,-.2,1).normalize();const e=new u(16777215);e.position.set(0,10,100),this.scene.add(t,e)}}export{b as EARTH_RADIUS,I as ThreeJSOverlayView,L as WORLD_SIZE,S as latLngToVector3Relative,C as latLngToXY,f as toLatLngAltitudeLiteral,D as xyToLatLng};
//# sourceMappingURL=index.esm.js.map
